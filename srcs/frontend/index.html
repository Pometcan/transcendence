<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
        />
        <title>Three.js with ES Modules</title>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
        ></script>

        <link
            rel="icon"
            type="image/png"
            href="./assets/favicon-B1U9ow1M.ico"
        />
        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@v0.171.0/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@v0.171.0/examples/jsm/"
                }
            }
        </script>
        <script
            type="module"
            crossorigin
            src="./assets/index-B8Ri6sGP.js"
        ></script>
        <link
            rel="modulepreload"
            crossorigin
            href="./assets/vendor-DcSP8lG2.js"
        />
        <style>
            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background-color: rgb(46, 49, 50);
                color: white;
            }
            .button-container {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }
            button {
                padding: 15px 30px;
                font-size: 1.2em;
                cursor: pointer;
                background-color: #121212;
                color: white;
                border: none;
                border-radius: 5px;
            }
            button:hover {
                background-color: #bca220;
            }
            #status {
                margin-top: 20px;
                font-size: 1.5em;
            }
            .hidden {
                display: none;
            }
            input {
                padding: 10px;
                font-size: 1em;
                margin-bottom: 10px;
                width: 200px;
                border-radius: 5px;
                border: 1px solid #ccc;
            }
            .form-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
        </style>
        <link rel="stylesheet" crossorigin href="./assets/index-CFDdbi_K.css" />
    </head>

    <body>
        <!--ft-transcendence></ft-transcendence-->
        <div id="testing">
            <button
                id="test"
                class="btn btn-outline-danger"
                onclick="postTest()"
            >
                Post at
            </button>
            <button
                id="test2"
                class="btn btn-outline-warning"
                onclick="getTest()"
            >
                get at
            </button>
        </div>

        <div class="form-container">
            <input
                type="text"
                id="userIdInput"
                placeholder="Kullanıcı ID'nizi girin"
            />
            <div class="button-container">
                <button id="hostBtn">Host</button>
                <button id="joinBtn">Join</button>
            </div>
        </div>
        <button id="pingBtn" class="hidden">Ping</button>
        <div id="status"></div>
    </body>
    <script>
        const hostBtn = document.getElementById("hostBtn");
        const joinBtn = document.getElementById("joinBtn");
        const pingBtn = document.getElementById("pingBtn");
        const statusDiv = document.getElementById("status");
        const userIdInput = document.getElementById("userIdInput");
        let websocket;
        let roomID;
        let userID;

        // Rastgele room_id oluştur
        function generateRoomID() {
            return (
                "ft" + Math.floor(100000 + Math.random() * 900000).toString()
            );
        }

        // WebSocket bağlantısını kur
        function connectWebSocket(path) {
            const websocketUrl = `wss://api.pometcan.com/${path}`;
            websocket = new WebSocket(websocketUrl, 'echo-protocol');
            websocket = new WebSocket(
                "wss://api." + window.location.host + path,
                'echo-protocol'
            );

            websocket.onopen = () => {
                console.log("WebSocket bağlantısı açıldı:", path);
                pingBtn.classList.remove("hidden"); // Ping butonunu göster
                statusDiv.textContent = "Bağlandı";
            };

            websocket.onmessage = (event) => {
                console.log("Gelen mesaj:", event.data);
            };

            websocket.onerror = (error) => {
                console.error("WebSocket hatası:", error);
                pingBtn.classList.add("hidden"); // Ping butonunu gizle
                statusDiv.textContent = "WebSocket hatası: " + error.message;
            };

            websocket.onclose = () => {
                console.log("WebSocket bağlantısı kapandı.");
                pingBtn.classList.add("hidden"); // Ping butonunu gizle
                statusDiv.textContent = "Bağlantı kapandı.";
            };
        }

        // POST isteği gönder
        async function sendPostRequest(url, data) {
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error("POST isteği hatası:", error);
                return {
                    status: "error",
                    message: "İstek gönderilirken bir hata oluştu.",
                };
            }
        }

        // Host butonu işlevi
        hostBtn.addEventListener("click", async () => {
            userID = userIdInput.value.trim();
            if (!userID) {
                alert("Lütfen bir Kullanıcı ID girin.");
                return;
            }

            roomID = generateRoomID();
            const response = await sendPostRequest(
                `https://api.${window.location.host}/game/host/`,
                { user_id: userID, room_id: roomID },
            );

            if (response.status === "success") {
                alert("Oda ID'niz: " + roomID);
                document
                    .querySelector(".form-container")
                    .classList.add("hidden"); // Formu gizle
                connectWebSocket("/ws/pong/" + roomID + "/" + userID);
            } else if (response.status === "error") {
                statusDiv.textContent =
                    "Hata: " + (response.message || "Bilinmeyen hata");
            } else {
                statusDiv.textContent = "Hata: Geçersiz yanıt formatı.";
            }
        });

        // Join butonu işlevi
        joinBtn.addEventListener("click", async () => {
            userID = userIdInput.value.trim();
            if (!userID) {
                alert("Lütfen bir Kullanıcı ID girin.");
                return;
            }

            roomID = prompt("Oda ID'sini girin:");
            if (!roomID) {
                alert("Lütfen bir Oda ID girin.");
                return;
            }

            const response = await sendPostRequest(
                `https://api.${window.location.host}/game/join/`,
                { user_id: userID, room_id: roomID },
            );

            if (response.status === "success") {
                document
                    .querySelector(".form-container")
                    .classList.add("hidden"); // Formu gizle
                connectWebSocket("/ws/pong/" + roomID + "/" + userID);
            } else if (response.status === "error") {
                statusDiv.textContent =
                    "Hata: " + (response.message || "Bilinmeyen hata");
            } else {
                statusDiv.textContent = "Hata: Geçersiz yanıt formatı.";
            }
        });

        // Ping butonu işlevi
        pingBtn.addEventListener("click", () => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ send: "ping" }));
                console.log(
                    "Ping mesajı gönderildi: Oda ID -",
                    roomID,
                    "Kullanıcı ID -",
                    userID,
                );
            } else {
                console.error(
                    "WebSocket bağlantısı açık değil veya tanımlı değil.",
                );
            }
        });

        function postTest() {
            fetch("https://api.pometcan.com/api/rest-auth/login/", {
                method: "POST",
                credentials: "include", // Tarayıcıdan çerez (cookie) göndermesi için gerekli!
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                    "X-CSRFTOKEN":
                        "vQKYVu8Eup2yFl7Hc06flOkL5n1V1kXPOHHTSh56nYaSPYEgBJI4PXh1278OrOhc",
                },
                body: JSON.stringify({
                    username: "pomet",
                    email: "po@po.com",
                    password: "123",
                }),
            })
                .then((response) => response.json())
                .then((data) => console.log(data))
                .catch((error) => console.error("Error:", error));
        }

        function getTest() {
            fetch("https://api.pometcan.com/api/rest-auth/user/", {
                method: "GET",
                credentials: "include", // Çerezleri backend'e göndermek için gerekli
                headers: {
                    Accept: "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => console.log(data))
                .catch((error) => console.error("Error:", error));
        }
    </script>
</html>
